//////////////////////////////////////////////////////////////////
// __        __     _       __  _                   _           //
// \ \      / /___ | |__   / _|(_)  ___  _ __    __| | ___  _   //
//  \ \ /\ / // _ \| '_ \ | |_ | | / _ \| '_ \  / _` |/ __|(_)  //
//   \ V  V /|  __/| |_) ||  _|| ||  __/| | | || (_| |\__ \ _   //
//    \_/\_/  \___||_.__/ |_|  |_| \___||_| |_| \__,_||___/(_)  //
//  ____          _         _                        ____       //
// / ___|  _ __  | |  __ _ | |_  ___    ___   _ __  |  _ \      //
// \___ \ | '_ \ | | / _` || __|/ _ \  / _ \ | '_ \ | | | |     //
//  ___) || |_) || || (_| || |_| (_) || (_) || | | || |_| |     //
// |____/ | .__/ |_| \__,_| \__|\___/  \___/ |_| |_||____/      //
//        |_|                                                   //
//////////////////////////////////////////////////////////////////

/*
    -------------------To Do-------------------

    __Alert the end of the game__
Let every player know the game has ended

    __Add a restart option__
Give players the option to restart the game

    __Add online functionality__
Ensure players from any machine can connect

    __Style the game__
    > Center the Board
    > Center the SplatoonD
    > Make the game code visible in the document
*/

// Set up the variables
const { response } = require('express');
const http = require('http');
const app = require('express')();
const ws = require('websocket').server;

// Get the index.html page and listen to port 3000
app.get('/', (req, res) => res.sendFile(__dirname + '/index.html'));
app.listen(3000, console.log(`App: Listening on port 3000`));

// Create the http server 
const httpServer = http.createServer();
httpServer.listen(9090, console.log(`HTTP: Listening on port 9090`));

// Create the client hashmap for all your webfiends
const clients = {};
const games = {};

// Create the websocket server
// My socks are soggy and gross!
const wss = new ws({
    'httpServer': httpServer
});

// On connecting to the server..
wss.on('request', (request) => {
    // Connect
    const connection = request.accept(null, request.origin);
    // On opening or closing a connection, relay that. 
    connection.on('open', () => console.log('Opened'));
    connection.on('close', () => console.log('Closed'));
    // On recieving a message, JSON parse the message and save it to result
    connection.on('message', (message) => {
        // This assumes all the messages being sent by the clients are JSON which is bad practice, but for simplicities sake, I am assuming all the clients will be good little webfiends. Webfriends, if you will
        const result = JSON.parse(message.utf8Data);
        // If the method is create...
        if (result.method === 'create') {
            // Assign the client ID and the game ID
            const clientID = result.clientID;
            const gameID = guid();
            // Add the game ID to the games object
            games[gameID] = {
                'id': gameID,
                'boxes': 64,
                'time': 30,
                'frame': 0,
                'clients': []
            };
            // Create the create payload 
            const payload = {
                'method': 'create',
                'game': games[gameID]
            };
            // Send the create payload for the game through the client connection
            const con = clients[clientID].connection;
            con.send(JSON.stringify(payload));
        };
        // If the method is join...
        if (result.method === 'join'){
            // Set the IDs and the Game
            const clientID = result.clientID;
            const gameID = result.gameID;
            const game = games[gameID];
            // If there are more than 5 players...
            if (game.clients.length >= 6) {
                // Notify that the maximum amount of players has been reached
                console.log(`Game (${gameID}) is at maximum capacity.`)
                return;
            };
            // Set the color for the player depending on which they are
            // 1 is Red, 2 is Cyan, 3 is Green, 4 is Yellow, 5 is Purple, 6 is Orange
            const color = {'0': '#ff0000', '1': '#00ffff', '2': '#00ff00', '3': '#ffff00', '4': '#ff00ff', '5': '#ff8800'}[game.clients.length]
            // Set the number for the player depending on which they are
            const player = {'0': 'Player 1', '1': 'Player 2', '2': 'Player 3', '3': 'Player 4', '4': 'Player 5', '5': 'Player 6'}[game.clients.length]
            // Add that client to the game
            game.clients.push({
                'clientID': clientID,
                'color': color,
                'player': player,
                'score': 0
            });
            // If there is more than one client, start the game
            if (game.clients.length > 1) update();
            // Create the join payload
            const payload = {
                'method': 'join',
                'game': game
            };

            // For each client in the game...
            game.clients.forEach((c) => {
                // Send a stringified payload to each client to notify that a new client has joined
                clients[c.clientID].connection.send(JSON.stringify(payload));
            });
        };
        // If the method is play... 
        if (result.method === 'play') {
            // Set the IDs for the game and box, and assign the box's color
            const gameID = result.gameID;
            const boxID = result.boxID;
            const color = result.color;
            // Assign the state of the game 
            let state = games[gameID].state;
            // If there is no state, assign an empty object to state
            if (!state) state = {};
            // Assign the client's color to the box and update the game state
            state[boxID] = color;
            games[gameID].state = state;
        };
    });
    // Generate a new client id
    const clientID = guid();
    // Where the client is in the clients object, set the connection
    clients[clientID] = {
        connection: connection
    };
    // Create the connect payload
    const payload = {
        'method': 'connect',
        'clientID': clientID
    };
    // Send the stringified payload (client connect)
    connection.send(JSON.stringify(payload));
});

// Create a function to update the game
let update = () => {
    // For game of games..
    // Loop through all the keys ( {'gameID':, gameID} )
    for (const g of Object.keys(games)) {
        // Set the game from the games object
        const game = games[g];
        // increment the game's frame by 1
        game.frame++;
        // Every 20 frames while the game is running...
        if ((game.frame % 20) === 0 && game.time > 0) {
            // Reset the frames back to 0 and deincrement the time by one
            game.frame = 0;
            game.time--;
        };
        // For each client in games...
        game.clients.forEach((c) => {
            // Reset that client's score
            c.score = 0;
            // If there is no game state, return
            if (!game.state) return;
            // For boxes of the game's state
            for (const b of Object.keys(game.state)) {
                // Set color to the box's color
                const color = game.state[b];
                // If the client's color is equal to the color
                if (c.color === color) {
                    // Increment score by one
                    c.score++;
                };
            };
        });
        // Create the update payload
        const payload = {
            'method': 'update',
            'game': game
        };
        // For each client in games...
        game.clients.forEach((c) => {
            // Stringify and send the update payload
            clients[c.clientID].connection.send(JSON.stringify(payload));
        });
    };
    setTimeout(update, 50);
};

// Create a function to randomly create a hex string 4 characters long
const hex = () => {
    return (((1+Math.random())*0x10000)|0).toString(16).substring(1); 
};

// Create a guid (Globally Unique Identifier) by concatenating multiple random hex strings together. Ensure they are all upper case
const guid = () => (hex() + '-' + hex()).toUpperCase();

// For anyone that needs a refresher on jolliness ðŸ‘‡
//................................................................................................................................................................................................................................
//................................................................................................................................................................................................................................
//................................................................................................................................................................................................................................
//................................................................................................................................:-==++++++++==-:................................................................................
//..............................................................................................................................-=+###%%#%%%%####*+=+++-..........................................................................
//............................................................................................................................:+#####@@@%#%%%%%%%######+=++=--....................................................................
//........................................................................................................................:-=+*####%@@@@%%#%@%@@@%%%##%%%%%%##*-..................................................................
//......................................................................................................................-+###*##%#%@@@@@@%#%@@@@%%%%@@@@@@@@@%#+-:................................................................
//....................................................................................................................-+#%%%%##%##@@@@@%%%#%@@@@%@@%@@@@@@@@%%%%%#-...............................................................
//..................................................................................................................-=#%%%%@%%%%##%@@@%%%%%@@@@@@@@@@@@@@@@%%%%####-..............................................................
//................................................................................................................:++#%%%%@@%%%%%#%%%%%@@%%%@%%%@@@@@@@@@@@@@@@%#%#+:.............................................................
//...............................................................................................................-+*#%%#%%@%@%%%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@%#*-.............................................................
//...............................................................................................................=##%%#%%@@@@%%%%%%%%%%%%%%#####**###%%%@%%@%%%%@@##=.............................................................
//..............................................................................................................:+#%%#%@@@@@@%%%%%%%%%%%##*+++========++#%%%%%%%%%@#+:............................................................
//.............................................................................................................-=##%%%@@%@@@@%%@@@%%%%%##*+===----==-===++*#%%%%%%#%+:............................................................
//...........................................................................................................-**+#%@@@%%@@@@@%%@@%%%%%##*+=-----------====+*#%%%%%%#+-............................................................
//.........................................................................................................:+####%%@@%%%@@@@@%%%@%%%%%%#+=-------------====+##%%%%%%#=:...........................................................
//........................................................................................................-##%%%%%%%%%%@@@@@%%%%%%#%%%#+=--------------====++#%%%%%%%*=...........................................................
//.......................................................................................................:#=:..:+##%%%@@@@%+===#%%#%%#+=--------------=--===+*#%%%%%%#+-..........................................................
//.......................................................................................................+#-.-++###%%%@@@@%+=-+=*%#%#+=----====+*+===-=--===+*###%#%%#+-:.........................................................
//......................................................................................................:**==+++*#%%%@@@@@@==+**####+==----=======*#+=---===+###%##%#*+-:.........................................................
//......................................................................................................:*##+++*#%%%%%@@@@@++*+#####+==---=+##%%##+++=====+#%%%%####*++-:.........................................................
//......................................................................................................:+#%#*###%%%%@@@@%@*++*#####+==---==+#%%+*#+=====+####%%%%##*++-:.........................................................
//.................................................................................................:==---=+=+###%%%%%%%@@@@@+=+##*#*++==----============%%%*#@%@%%##+=#=:.........................................................
//........................................................................................................::=*#%%%%#%%%%@@@@@++#*++*++====--=================#%%%##*+*#=:.........................................................
//...............................................................................................:.......:-=+==+#%%#%@%%@@@@%#*#*+++++=====--================*%%%##++%+=:.........................................................
//......................................................................................................::-:-.:=###%%%%%%@@@%#+**++++++===============--=====#@%%%%##+==..........................................................
//......................................................................................................::-=-.:##*#%@%%%%%@@%#++++++++==++==============-====@%%@%%%=+=:..........................................................
//..................................................................................................:...::-+*%#++#%%%%%%@@@@%#+++=++++++==++================#%%%%##%++-...........................................................
//..................................................................................................::...:+==:=*#%%%%%%@@@@@%#+=++==+++**+++++=============#####%#%*+=............................................................
//...................................................................................................:...:::++##%@%%@@%%%%%%##%%##*=======++*##*+**#*++==+%####%%%##*:............................................................
//...................................................................................................:..::..-=*%%##+=+%%%###=---=+##*=========+##**+*#==#%%%%%##*++++-............................................................
//..............................................................:..:.................................:..:...-++=---::------------===+#+=========+*#**=+%%%#%##*++###=:-:..........................................................
//...........................................................::::::::................................:.:.:=***=-::::::----------------===============*%%%%%###*+-**=*+:-:.........................................................
//.:......................................................::::.::::::::...............:..............::.:+++=--::::::----=====---------==+==========#%%%@%###*##===-*+=:..........................................................
//........................................................:....::::::::..............::..............::-+++---:-:---==+#########+=--------========+%%@@@@%%%#**#==--+-=+:.........................................................
//............................................................::::..:.................:..:....:......::++*=-------=+###############+=-------=+#####*####%%#%%**+%*=-===--.........................................................
//..............................::............................::::::......:........::::.......::......-*++=------+###################*=-------=#%##**++++++++++#%%%*+-=---:::.............:.......................................
//...........:..........:..::::::.:::...:.........:.:::::...:::::::::...:::.:::::::::.::::::.:::::.:::-++==+=-=-=######################+----:---=+*##++========+*%%##*+=:-:::...:..:.....::...................:................:..
//.:............::..::..:..:::..:.:::::.:::.......::.::.:..::..:::::..................................-+-**+====#########################=-----:--=+#*+=====----==#@%#+*--:::::::.::...::::::::..:::.........:::.........:::::.::.
//....................................................................................................:*--#####*#################**#####%#=--::::---=++==--------=+%@%*+=.................................................:::.....
//.....................................................................................................-*:=+*%@##################*######%%%+---::::----===---------=%@%==.........................................................
//.......................................................................................................:=#=+@##########################%%#=--:::::::---------------+%#=.........................................................
//.........................................................................................................=#=%###################%##%%##%%%#+--::::::-----------:-:--##-.........................................................
//........................................................................................................:#=#@#################%##%#%%%%#%%%#+---::::::---=----:::::--=-.........................................................
//......................................................................................................-+#--@%+###################%####%%#%%%#*+--:::::---------::::::-..........................................................
//...................................................................................................-+*+==+%%#####################%%####%%%%%###+---::::::--------:::::..........................................................
//...................................................................................................:=--=%%#%#+#################%##%##%##%%#######+-:::::::::::::-::::::.........................................................
//.....................................................................................................-*%==#-:+#################%##%#####%%%#######+--:::::::::::::::::::........................................................
//.....................................................................................................:#++=%=-+###################%#%%%##%%#%%%#####*=-:::::::::::::::::::.......................................................
//......................................................................................................:=#%-*+*****####################%##%%#########*+--::::::::::::::::........................................................
//.........................................................................................................=*+-+#**##########%%##########%#%%##*#########+--:::::::::::::::.......................................................
//......................:..................................................................................:.+--##########################%#%#############*=--:::::::::::.........................................................
//................:-*########+-..............................................................................+:-#################%##%###%##%%%%%%############+--:::::::::.:.......................................................
//..............-#=:.....:=#####+:.........................................................................:+:+==###################%%%##%##%%#################=-::::::::::.......................................................
//............-#-...........:*####-......:-*-......:....................................................:---::..:*#####################%##%#%%##%###############=---:::::::.......................................................
//...........=*:..............=####=...-*#####=..:+##*-:::-*-....................................................+#################%########%%%%################*=-----::-:.......................................................
//..........-*:................=####+*=:..:*####=+-+####*-+-.....................................................-##########%###########%##%#%%%%%#%###############*++=-++-.......................................................
//.........-#=.................:*####:.....:*###+.......:+=................:......................................+#####################%##%#%##%%#%##%###################:.......................................................
//.........+#-......:*###*-.....-####+......=####:......+*:...............*--.....................................-################%%#%#######%%%###%####################*:.......................................................
//........:*#-......--:-+##=.....*####:.....-####:.....=#-...............:#-.......................................+############%####%#######%%%%#########################-.......................................................
//........:*#+...........+#+.....=####-.....-###+.....-#*..-==+:-+:+---=--#==:.=---==-:-=:*=.#-%:-.................-#########################%%%%#######%#%###############-.......................................................
//.........+##-..........-#-.....-####-.....-###=....:*#+...=--..-::-:---:-.-...--.-:-..-::-::-%:..................:+##################%######%%%%%#%%#%%#%###############-.......................................................
//.........=###-.........++......-####=.....-###-....=##=....................................=:+....................-##########%##############%%%%###%####################=.......................................................
//..........=###+-.....-+-.......:####-.....-###:...:*##=....................................::.....................:*#########################%%###%%#%#%%###########%%##+.......................................................
//...........:*########-.........:####-.....-##-....-###--=+*##*+-:..................................................-####%###%########%#######%%%%%%#%%##############%%###:......................................................
//................:..............-####:.....=#+.....=###+-::-+#####+.................................................:*##########%%######%#####%%#%%##%%%%%##########%%%##%-......................................................
//...............................=###=......++.....:*###-.......-###+.................................................=###############%#########%%%%%%%##%%##########%%%%%#=......................................................
//...............................+##*......+-....:*-+###-........:*##-................................................:##############%###%######%%%%%%%###%%#########%%%%%#*......................................................
//..............................:###-...........-#:.+###=.........-##-.................................................=####%###########%#####%###%%%%%%%%%%########%%%%%%##:.....................................................
//..............................+##=...........+#:..=###+.........:##:.................................................-###########%##############%%%%#%##%#%#######%%%%%###-.....................................................
//:...........+####+:..........=##=...........+#-...-###*:........-#-..................................................:*###########%##############%%%%%%##%########%%%%####+.....................................................
//:..........=###-............-##-..........:+#+....:*###=........+=....................................................=#####%######################%%%%%#%########%%%%%%##*:....................................................
//...........=#*:...........:=#+:...........=##:.....=####-.....:+-.....................................................-##%###########%######%######%%#%##########%%%%%%%###:....................................................
//:..........-#+..........:=#+:............-##+.......+####-::-*+.......................................................-##################%###########%%%#########%%%%%#####-....................................................
//:...........:=*=-:::-=+*+-...............+##=........=#####*=.........................................................=###########%%#%##%###########%%%#%%#######%%%%%##%##-....................................................
//.................:::....................:###=...........:............................................................:+###**#################%#%#######%%%%######%%%%%%####-....................................................
//........................................-###=...--..................................................................:-####***#####%%#########%###%####%%%#######%%%####%###=....................................................
//........................................=###+..=-=....:=....:=......................................................+%%%%#*###########################%%%%%####%%%%%%%%####=....................................................
//:.................:::.:..:.::..::.:.:...=###*..==:.::..-.::.-=.:::::.:::.-:........................................:#%%%%%%@@%%#%%#########%##%####%###%%@%%#*%%@%%%%%%#%##=....................................................
//..................*-%:#:*=:-==--+:*:+::.-####-.=:+::=:=*:=+--=:%:%:#:+:+-:=.:......................................=%#%%%@@@@@%%%@#*###################%@@@#@@@%@%%%%%%####=....................................................
//...................................-+...:####+....................................................................:#%%%%%@@@@%%#%@@%#####*##############%@%@@@%+@%%%%%%####=....................................................
//.................................:=--....+####-...................................................................=#%@%@@@@@%%%#@@@@%######%##%%##%###%#@@%@@%#*@%%%%%%%###=....................................................
//.........................................:*###*:.....................==...........................................=##%%%@@@@%%%%@@@@@%#######%#%%#%#####%%*@%%##@%%%%%#####=....................................................
//..........................................:####*:...................==...........................................-#####%%%%%%%@@@@@@@@##########%##%######%%%%*#@%%%%#%####=....................................................
//............................................+####-................:=-...........................................-###########%%%%%%%%@@@%############%#####%%%%*%@%%%%%#####+....................................................
//.............................................:+###+:............:==:...........................................:*#####*#######%%#%%%%%%%%#####%%##%#%%####%@%%%%%%%%%%######-...................................................
//...............................................:=*###=-:....::=+=:............................................:+#########%##%###%%##%%%%%%#######%%##%%####%%###%%##%%######=...................................................
//:..................................................:-==++++=-:................................................=##############%##%#####%%%%%%#####%%##%#%%###%##+*##*###*+==-:...................................................
//.............................................................................................................=##########%#####%####%##%%%%%%%%%%####%%#%%####%*+=++====---:::...................................................
//............................................................................................................:*###############%%%#%#%%%#%%#%%%%##%####%##%#####++=-------:::::...................................................
//...........................................................................................................:+########*#############%%#%#%%%%%%%%##############+==-----::::::::..................................................
//...........................................................................................................-################%###%%##%#%%%%%%%%%%%%%##%########*=-----::::::::...................................................
//:.........................................................................................................:+###############################%%%%%%####%%%%######*----:::::::::::.................................................
//:.........................................................................................................-#####*###################%%##%%%#%%%%%%%%#######%%###--:::::::::::::.................................................
//:.........................................................................................................+##############################%###%%%%%%%%%%%#%%##%#=--:::::::::::::::...............................................
//.........................................................................................................:+*####################*++#######***##%%%%%%%%#%###**=--::::::::::::::::...............................................
//.........................................................................................................:*###################%###############%%%%%####%###++=--:::::::::::::::.................................................
//:........................................................................................................-*###################%#################%%%#++=++++----::::::::::::::...................................................
//.........................................................................................................:*#########################################+=-------:::::::::::::::--..................................................
//:........................................................................................................:*################%##################%%######*=---::::::::::::::::--*#=:...............................................
//..........................................................................................................+#############################################+-----:::::::::::----*###*-.............................................
//..........................................................................................................=##############################################*==-----:::::::-----=#####*=:..........................................
//..........................................................................................................-################################################*##==-----------=--######*+=:........................................
//...........................................................................................................+######################################################+==--=------+########*+-......................................
//...........................................................................................................-##########################################################+====---=###########+-....................................
//:.....................................................................................................::....=###########################################################*+==---############*+-..................................
//...................................................................................................::::.::::.+#############################################################+==--##############*-................................
//......................................................................................................::::--.:+##*###########################################################+===%##############*-..............................
//....................................................................................................:.:::::---:*#######*#################################################*+*#**=+%#############*#*+-............................
//.....................................................................................................::::::::---+##########################*+##################################*+%###########**#****+:..........................
//........................................................................................................::::::---=#################################################################%#########*##******=:........................
//.....................................................................................................::..::::::---=+########################*########################################################*#*-::::...................
//.......................................................................................................:::.:::::---==*%############################################################**###################+-:::::.................
//....:..................................................................................................:..:::::::--=---+###############################################################################*++=-::::................
//........................................................................................................::::::::----------=++*##########################################################*###############**+=-:::................
//.....................................................................................................:::::.::::.....::.:--------=*########################################################*##############**-:.:.................
//.::.................................................................................................:...................::::::::::::--=+#######################################**##*####*+****#######+=-:-=:....................
//...:....................................................................................................................:......:::.......:+####*#############################*#*#*###**###**#*-+++=-:...........................
//..........................................................................................................................................:.:::::+-:-+####+=.:+###################**##*#######+=-...............................
//::..:...................................................................................................................................................-=:....:########*######+##**###+#*###+*+:...............................
//.:................................................................................................................................................................:..:+##########*#**####**##*#=................................
//.......................................................................................................................................................................:-+##*#**====**=+*++=-:..................................