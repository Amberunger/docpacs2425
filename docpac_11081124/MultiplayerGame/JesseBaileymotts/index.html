<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <title>SplatoonD</title>
</head>
<body>
    <h1>SplatoonD</h1>
    <button id='newGame'>New Game</button>
    <button id='joinGame'>Join Game</button>
    <input type='text' id='code'>
    <div id='clock'>Time: <div>
    <div id="players"></div>
    <div id='board'></div>
    <script>
        //// HTML Elements
        const newGame = document.getElementById('newGame');
        const joinGame = document.getElementById('joinGame');
        const code = document.getElementById('code');
        const players = document.getElementById('players');
        const board = document.getElementById('board');
        const clock = document.getElementById('clock');
        
        //// Splatoon 2D Variables
        // It is poor practice to make the websocket like this. However my dearest little webfiends, it okay
        let ws = new WebSocket('ws://localhost:9090');
        let clientID = null;
        let gameID = null;
        let pColor = null;
        let timer = 5;

        //// HTML Events
        // On clicking join game...
        joinGame.addEventListener('click', (e) => {
            // Create the join payload
            if (gameID === null) {
                gameID = code.value;
            }
            const payload = {
                'method': 'join',
                'clientID': clientID,
                'gameID': gameID
            };
            // Stringify and send the join payload
            ws.send(JSON.stringify(payload));
        });
        // On clicking new game...
        newGame.addEventListener('click', (e) => {
            // Create the create payload
            const payload = {
                'method': 'create',
                'clientID': clientID
            };
            // Stringify and send the create payload
            ws.send(JSON.stringify(payload));
        });

        // On recieving a websocket message...
        ws.onmessage = message => {
            const response = JSON.parse(message.data);
            // If the method is connect...
            if (response.method == 'connect') {
                // Assign and relay the client ID
                clientID = response.clientID;
                console.log(`Client ID Set: ${clientID}`);
            };
            // If the method is create...
            if (response.method === 'create') {
                // Assign and relay the game ID
                gameID = response.game.id;
                console.log(`Game ID Set: ${response.game.id}`);
            };
            // If the method is join...
            if (response.method === 'join') {
                // Assign the game
                game = response.game;
                // While the players div has elements, remove the first element
                while (players.firstChild) players.removeChild(players.firstChild);
                // For each client in the game...
                game.clients.forEach((c) => {
                    // Create a div element, style it, and add into it the client ID
                    const div = document.createElement('div');
                    div.style.width = '3.5rem';
                    div.style.background = c.color;
                    div.textContent = c.number;
                    // If the client's ID matches, the current client, their player color is the client's color
                    if (c.clientID === clientID) pColor = c.color;
                    // Append the client's div to the players div
                    players.appendChild(div);
                });
                // While the board div has elements, remove the first element
                while (board.firstChild) board.removeChild(board.firstChild);
                // Start i at 0. While i is less than the game boxes, increment i by 1 and...
                for (let i = 0; i < game.boxes; i++) {
                    // Create a button element and assign an ID and Tag
                    const box = document.createElement('button')
                    box.id = 'b'+(i+1);
                    box.tag = i+1;
                    // Style the button
                    box.textContent = i+1;
                    box.style.width = '4.5rem';
                    box.style.height = '4.5rem';
                    // Add clicking functionality to the button
                    box.addEventListener('click', (e) => {
                        // If the timer is greater than 0...
                        if (timer > 0) {
                            // Set the clicked box to the player color
                            box.style.background = pColor;
                            // Create the play payload
                            const payload = {
                                'method': 'play',
                                'clientID': clientID,
                                'gameID': gameID,
                                'boxID': box.tag,
                                'color': pColor
                            }
                            // Stringify and send the play payload
                            ws.send(JSON.stringify(payload));
                            // Else, return
                        } else return;
                    });
                    // Append the box to the board. If there are eight boxes already, break
                    // Results in a 8 x 8 grid
                    // If the total boxes are increased, it must be exponentially to result in an evenly distributed and, thus, square grid
                    board.appendChild(box);
                    if (((i + 1) % (game.boxes / Math.sqrt(game.boxes))) === 0) board.appendChild(document.createElement('br'));
                };
            };
            // If the method is update...
            if (response.method === 'update') {
                // If there is no game state, return
                if (!response.game.state) return;
                // For boxes of the game's state...
                for (const b of Object.keys(response.game.state)) {
                    const color = response.game.state[b];
                    const boxObj = document.getElementById('b' + b);
                    boxObj.style.backgroundColor = color;
                };
            };
        };
    </script>
</body>
</html>