//////////////////////////////////////////////////////////////////
// __        __     _       __  _                   _           //
// \ \      / /___ | |__   / _|(_)  ___  _ __    __| | ___  _   //
//  \ \ /\ / // _ \| '_ \ | |_ | | / _ \| '_ \  / _` |/ __|(_)  //
//   \ V  V /|  __/| |_) ||  _|| ||  __/| | | || (_| |\__ \ _   //
//    \_/\_/  \___||_.__/ |_|  |_| \___||_| |_| \__,_||___/(_)  //
//  ____          _         _                        ____       //
// / ___|  _ __  | |  __ _ | |_  ___    ___   _ __  |  _ \      //
// \___ \ | '_ \ | | / _` || __|/ _ \  / _ \ | '_ \ | | | |     //
//  ___) || |_) || || (_| || |_| (_) || (_) || | | || |_| |     //
// |____/ | .__/ |_| \__,_| \__|\___/  \___/ |_| |_||____/      //
//        |_|                                                   //
//////////////////////////////////////////////////////////////////

/*
------------------- To Do -------------------
    __Restart__
Give players the option to restart the game

    __Leave__
Give the players the option to leave the game. If they are the owner, delete the game

    __Game Settings__
Allow the game to be customized by the host

    __Log In__
Create a log in system to save your settings and track your wins

    __Formbar Oauth2__
Implement Oauth2 using the formbar

    __Leaderboard__
Create a leaderboard to show the top players, their wins, their win rates, win loss ratio

    __Settings__
Create a settings page to change your display name, color, and other settings

    __Power Ups__
Add power ups to the game to give players an advantage
Possible power ups:
    - Inkroller (Covers a 3x3 area)
    - Ink Wall (Prevents a box from being clicked)
    - Inknade (Erases color in a 5x5 area)

    __Teams__
Add teams to the game to allow players to play cooperatively

    __Bug Fixes__
Fix bugs that will inevitably arise
    Known bugs:
*/

// Set up the variables
const express = require('express');
const app = express();
const {createServer} = require('http');
const ws = require('websocket').server;

// Make the static directory the current directory
app.use(express.static(__dirname + '/'));
app.set('view engine', 'ejs');

// Listen on port 3000 and relat that
app.listen(3000, console.log(`App: Listening on port 3000`));

// Get the index page
app.get('/', (req, res) => {
    res.render('index');
});

// Get the game page
app.get('/game', (req, res) => {
    res.render('game');
});

//
app.get('/login', (req, res) => {
    // res.render('login');
    return
});

//
app.get('/leaderboard', (req, res) => {
    // res.render('leaderboard');
    return
});

//
app.get('/settings', (req, res) => {
    // res.render('settings');
    return
});

// Create the http server 
const httpServer = createServer();
httpServer.listen(9090, console.log(`HTTP: Listening on port 9090`));

// Create the client hashmap for all your webfiends
const clients = {};
const games = {};

// Create the websocket server
// My socks are soggy and gross!
const wss = new ws({
    'httpServer': httpServer
});

// On connecting to the server..
wss.on('request', (request) => {
    // Assign the connection to the request and accept the connection
    const connection = request.accept(null, request.origin);
    // On closing a connection...
    connection.on('close', () => {
        // Find the client by the connection and assign it to clientID
        const clientID = Object.keys(clients).find((c) => clients[c].connection === connection);
        // Delete the client from the clients list
        delete clients[clientID];
        // If that client is in a game, delete them from the game
        // For each game in games...
        Object.keys(games).forEach((g) => {
            // Assign the game from the games object
            const game = games[g];
            // Find the client by the client ID and assign it to clientIndex
            const clientIndex = game.clients.findIndex((c) => c.clientID === clientID);
            // If the client index is not negative one...
            if (clientIndex !== -1) {
                const client = game.clients[clientIndex];
                // Add the player's slot and color back to the available lists
                game.slots.push(client.player);
                game.colors.push(client.color);
                // Sort the available slots to maintain the correct order
                game.slots.sort();
                game.colors.sort();
                // Splice that client from the game
                game.clients.splice(clientIndex, 1);
                // If the game has no clients, delete the game
                // If there are no clients in the game...
                if (game.clients.length === 0) {
                    // Delete that game from games
                    delete games[g];
                };
            };
            // Create the disconnect payload
            const payload = {
                'method': 'disconnect',
                'clientID': clientID
            };
            // For each client in the game...
            game.clients.forEach((c) => {
                // Send a stringified payload to each client to notify that a client has disconnected
                if (clients[c.clientID]) {
                    clients[c.clientID].connection.send(JSON.stringify(payload));
                };
            });
        });
    });
    // On recieving a message, JSON parse the message and save it to result
    connection.on('message', (message) => {
        // This assumes all the messages being sent by the clients are JSON which is bad practice, but for simplicities sake, I am assuming all the clients will be good little webfiends. Webfriends, if you will
        const result = JSON.parse(message.utf8Data);
        // If the method is create...
        if (result.method === 'create') {
            // Assign the client ID and the game ID
            const clientID = result.clientID;
            // If the client has already created a game, return
            if (comb(clientID, 'create')) return;
            const gameID = guid();
            // Add the game ID to the games object
            games[gameID] = {
                'id': gameID,
                'boxes': 64,
                'time': 5,
                'frame': 0,
                'clients': [],
                'creator': clientID
            };
            // Create the create payload 
            const payload = {
                'method': 'create',
                'game': games[gameID]
            };
            // Send the create payload for the game through the client connection
            clients[clientID].connection.send(JSON.stringify(payload));
        };
        // If the method is join...
        if (result.method === 'join'){
            // Set the IDs and the Game
            const clientID = result.clientID;
            const gameID = result.gameID;
            // If there is no gameID or the player is in a game, return
            if (!gameID) return;
            // Set the game from the games object
            const game = games[gameID];
            if (comb(clientID)) return;
            // if (client) return;
            // If there are more than 5 players...
            if (game.clients.length >= 6) {
                // Notify that the maximum amount of players has been reached
                console.log(`Game (${gameID}) is at maximum capacity.`)
                // Return
                return;
            };
            // If the slots or colors of the game do not exist, create the slots and colors arrays
            if (!game.slots || !game.colors) {
                game.slots = ['Player 1', 'Player 2', 'Player 3', 'Player 4', 'Player 5', 'Player 6'];
                game.colors = ['#da0000', '#000bda', '#00961c', '#c7de00', '#b700b1', '#eaa400'];
            }
            // Get the lowest available slot and color
            const player = game.slots.shift();
            const color = game.colors.shift();
            // Add that client to the game
            game.clients.push({
                'clientID': clientID,
                'color': color,
                'player': player,
                'score': 0
            });
            // Create the join payload
            const payload = {
                'method': 'join',
                'game': game
            };
            
            // For each client in the game...
            game.clients.forEach((c) => {
                // Send a stringified payload to each client to notify that a new client has joined
                if (clients[c.clientID]) {
                    clients[c.clientID].connection.send(JSON.stringify(payload));
                };
            });
        };
        // If the method is start...
        if (result.method === 'start') {
            // Set the game's ID, set the player that sent the payload, and set the game
            const gameID = result.gameID;
            const player = result.player;
            const game = games[gameID];
            // If there is no gameID and the user is not player 1, return
            if (!gameID || player !== 'Player 1') {
                return;
            };
            // If there is more than one client, start the game
            if (game.clients.length > 1) update(gameID);
            const payload = {
                'method': 'start',
                'game': game
            };
        };
        // If the method is play... 
        if (result.method === 'play') {
            // Set the IDs for the game and box, and assign the box's color
            const gameID = result.gameID;
            const boxID = result.boxID;
            const color = result.color;
            // Assign the state of the game 
            let state = games[gameID].state;
            // If there is no state, assign an empty object to state
            if (!state) state = {};
            // Assign the client's color to the box and update the game state
            state[boxID] = color;
            games[gameID].state = state;
        };
        // If the method is restart...
        if (result.method === 'restart') {
            // Set the game's ID and set the game using the ID
            const gameID = result.gameID;
            const game = games[gameID]
            // If there is no game, return
            if (!game) return;
            // Reset the game's time and frame
            game.time = 5;
            game.frame = 0;
            // Reset the game's state and reset the client's scores
            game.state = {};
            game.clients.forEach((c) => {
                c.score = 0;
            });
            // Create the restart payload
            const payload = { 
                'method': 'restart',
                'game': game
            };
            // For each client in the game...
            game.clients.forEach((c) => {
                // If that client exists, send the stringified payload
                if (clients[c.clientID]) {
                    clients[c.clientID].connection.send(JSON.stringify(payload));
                };
            });
        };
        // If the method is leave...
        if (result.method === 'leave') {
            // Set the game's ID, the client ID, and set the game using the ID
            const clientID = result.clientID;
            const gameID = result.gameID;
            const game = games[gameID];
            // Create the leave payload
            const payload = {
                'method': 'leave',
                'game': game
            };
            // For each client in the game...
            game.clients.forEach((c) => {
                // If that client exists, send the stringified payload
                if (clients[c.clientID]) {
                    clients[c.clientID].connection.send(JSON.stringify(payload));
                };
            });
            // If the game's creator is the client, delete the game
            if (game.creator === clientID) delete game;
        };
    });
    // Generate a new client id
    const clientID = guid();
    // Where the client is in the clients object, set the connection
    clients[clientID] = {
        connection: connection
    };
    // Create the connect payload
    const payload = {
        'method': 'connect',
        'clientID': clientID,
        'games': games
    };
    // Send the stringified payload (client connect)
    connection.send(JSON.stringify(payload));
});

// Create a function to update the game by gameID
let update = (gameID) => {
    // Get the game by gameID.
    const game = games[gameID];
    // If the game does not exist, return
    if (!game) return;
    // Increment the game's frame by 1
    game.frame++;
    // Every 20 frames while the game is running...
    if ((game.frame % 20) === 0 && game.time > 0) {
        // Reset the frames back to 0 and deincrement the time by one
        game.frame = 0;
        game.time--;
    };
    // For each client in the game...
    game.clients.forEach((c) => {
        // Reset that client's score
        c.score = 0;
        // If there is no game state, return
        if (!game.state) return;
        // For boxes of the game's state
        for (const b of Object.keys(game.state)) {
            // Set color to the box's color
            const color = game.state[b];
            // If the client's color is equal to the color
            if (c.color === color) {
                // Increment score by one
                c.score++;
            };
        };
    });
    // Create the update payload
    const payload = {
        'method': 'update',
        'game': game
    };
    // For each client in the game...
    game.clients.forEach((c) => {
        // Stringify and send the update payload
        if (clients[c.clientID]) {
            clients[c.clientID].connection.send(JSON.stringify(payload));
        };
    });
    // Set a timeout to update every 50 milliseconds (1/20th of a second)
    // 20 frames per second
    setTimeout(() => update(gameID), 50);
};

// Create a function to check if a client is in a game taking clientID and method as arguments
let comb = (clientID, method) => {
    // Set combed to false
    let combed = false
    // If the method is create...
    if (method === 'create') {
        // For each game in games...
        Object.keys(games).forEach((g) => {
            // Set client equal to whether or not the game's creator is the clientID
            const client = games[g].creator === clientID;
            // If client is true, set combed to true. Else, don't do anything
            client ? combed = true : null;
        });
    // Else...
    } else {
        // For each game in games...
        Object.keys(games).forEach((g) => {
            // Set client equal to whether or not the clientID is in the game's clients
            const client = games[g].clients.find((c) => c.clientID === clientID) ;
            // If client is true, set combed to true. Else, don't do anything
            client ? combed = true : null;
            });
    };
    // Return combed
    return combed;
};

// Create a function to randomly create a hex string 4 characters long. It does this by...
// Get a random number between 1 and 2, excluding 1 and 2, and multiply it by 0x10000 (a hex representation of 2^16) 
// (Results in a number from 131072 to 65536)
// Quickly convert said number to an integer, and then, convert the number to a hex string
// Slice the string to remove the first character and return the hex string
const hex = () => {
    return (((1+Math.random())*0x10000)|0).toString(16).substring(1); 
};

// Create a guid (Globally Unique Identifier) by concatenating multiple random hex strings together. Ensure they are all upper case
const guid = () => (hex() + '-' + hex()).toUpperCase();

// For anyone that needs a refresher on jolliness 👇
//................................................................................................................................................................................................................................
//................................................................................................................................................................................................................................
//................................................................................................................................................................................................................................
//................................................................................................................................:-==++++++++==-:................................................................................
//..............................................................................................................................-=+###%%#%%%%####*+=+++-..........................................................................
//............................................................................................................................:+#####@@@%#%%%%%%%######+=++=--....................................................................
//........................................................................................................................:-=+*####%@@@@%%#%@%@@@%%%##%%%%%%##*-..................................................................
//......................................................................................................................-+###*##%#%@@@@@@%#%@@@@%%%%@@@@@@@@@%#+-:................................................................
//....................................................................................................................-+#%%%%##%##@@@@@%%%#%@@@@%@@%@@@@@@@@%%%%%#-...............................................................
//..................................................................................................................-=#%%%%@%%%%##%@@@%%%%%@@@@@@@@@@@@@@@@%%%%####-..............................................................
//................................................................................................................:++#%%%%@@%%%%%#%%%%%@@%%%@%%%@@@@@@@@@@@@@@@%#%#+:.............................................................
//...............................................................................................................-+*#%%#%%@%@%%%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@%#*-.............................................................
//...............................................................................................................=##%%#%%@@@@%%%%%%%%%%%%%%#####**###%%%@%%@%%%%@@##=.............................................................
//..............................................................................................................:+#%%#%@@@@@@%%%%%%%%%%%##*+++========++#%%%%%%%%%@#+:............................................................
//.............................................................................................................-=##%%%@@%@@@@%%@@@%%%%%##*+===----==-===++*#%%%%%%#%+:............................................................
//...........................................................................................................-**+#%@@@%%@@@@@%%@@%%%%%##*+=-----------====+*#%%%%%%#+-............................................................
//.........................................................................................................:+####%%@@%%%@@@@@%%%@%%%%%%#+=-------------====+##%%%%%%#=:...........................................................
//........................................................................................................-##%%%%%%%%%%@@@@@%%%%%%#%%%#+=--------------====++#%%%%%%%*=...........................................................
//.......................................................................................................:#=:..:+##%%%@@@@%+===#%%#%%#+=--------------=--===+*#%%%%%%#+-..........................................................
//.......................................................................................................+#-.-++###%%%@@@@%+=-+=*%#%#+=----====+*+===-=--===+*###%#%%#+-:.........................................................
//......................................................................................................:**==+++*#%%%@@@@@@==+**####+==----=======*#+=---===+###%##%#*+-:.........................................................
//......................................................................................................:*##+++*#%%%%%@@@@@++*+#####+==---=+##%%##+++=====+#%%%%####*++-:.........................................................
//......................................................................................................:+#%#*###%%%%@@@@%@*++*#####+==---==+#%%+*#+=====+####%%%%##*++-:.........................................................
//.................................................................................................:==---=+=+###%%%%%%%@@@@@+=+##*#*++==----============%%%*#@%@%%##+=#=:.........................................................
//........................................................................................................::=*#%%%%#%%%%@@@@@++#*++*++====--=================#%%%##*+*#=:.........................................................
//...............................................................................................:.......:-=+==+#%%#%@%%@@@@%#*#*+++++=====--================*%%%##++%+=:.........................................................
//......................................................................................................::-:-.:=###%%%%%%@@@%#+**++++++===============--=====#@%%%%##+==..........................................................
//......................................................................................................::-=-.:##*#%@%%%%%@@%#++++++++==++==============-====@%%@%%%=+=:..........................................................
//..................................................................................................:...::-+*%#++#%%%%%%@@@@%#+++=++++++==++================#%%%%##%++-...........................................................
//..................................................................................................::...:+==:=*#%%%%%%@@@@@%#+=++==+++**+++++=============#####%#%*+=............................................................
//...................................................................................................:...:::++##%@%%@@%%%%%%##%%##*=======++*##*+**#*++==+%####%%%##*:............................................................
//...................................................................................................:..::..-=*%%##+=+%%%###=---=+##*=========+##**+*#==#%%%%%##*++++-............................................................
//..............................................................:..:.................................:..:...-++=---::------------===+#+=========+*#**=+%%%#%##*++###=:-:..........................................................
//...........................................................::::::::................................:.:.:=***=-::::::----------------===============*%%%%%###*+-**=*+:-:.........................................................
//.:......................................................::::.::::::::...............:..............::.:+++=--::::::----=====---------==+==========#%%%@%###*##===-*+=:..........................................................
//........................................................:....::::::::..............::..............::-+++---:-:---==+#########+=--------========+%%@@@@%%%#**#==--+-=+:.........................................................
//............................................................::::..:.................:..:....:......::++*=-------=+###############+=-------=+#####*####%%#%%**+%*=-===--.........................................................
//..............................::............................::::::......:........::::.......::......-*++=------+###################*=-------=#%##**++++++++++#%%%*+-=---:::.............:.......................................
//...........:..........:..::::::.:::...:.........:.:::::...:::::::::...:::.:::::::::.::::::.:::::.:::-++==+=-=-=######################+----:---=+*##++========+*%%##*+=:-:::...:..:.....::...................:................:..
//.:............::..::..:..:::..:.:::::.:::.......::.::.:..::..:::::..................................-+-**+====#########################=-----:--=+#*+=====----==#@%#+*--:::::::.::...::::::::..:::.........:::.........:::::.::.
//....................................................................................................:*--#####*#################**#####%#=--::::---=++==--------=+%@%*+=.................................................:::.....
//.....................................................................................................-*:=+*%@##################*######%%%+---::::----===---------=%@%==.........................................................
//.......................................................................................................:=#=+@##########################%%#=--:::::::---------------+%#=.........................................................
//.........................................................................................................=#=%###################%##%%##%%%#+--::::::-----------:-:--##-.........................................................
//........................................................................................................:#=#@#################%##%#%%%%#%%%#+---::::::---=----:::::--=-.........................................................
//......................................................................................................-+#--@%+###################%####%%#%%%#*+--:::::---------::::::-..........................................................
//...................................................................................................-+*+==+%%#####################%%####%%%%%###+---::::::--------:::::..........................................................
//...................................................................................................:=--=%%#%#+#################%##%##%##%%#######+-:::::::::::::-::::::.........................................................
//.....................................................................................................-*%==#-:+#################%##%#####%%%#######+--:::::::::::::::::::........................................................
//.....................................................................................................:#++=%=-+###################%#%%%##%%#%%%#####*=-:::::::::::::::::::.......................................................
//......................................................................................................:=#%-*+*****####################%##%%#########*+--::::::::::::::::........................................................
//.........................................................................................................=*+-+#**##########%%##########%#%%##*#########+--:::::::::::::::.......................................................
//......................:..................................................................................:.+--##########################%#%#############*=--:::::::::::.........................................................
//................:-*########+-..............................................................................+:-#################%##%###%##%%%%%%############+--:::::::::.:.......................................................
//..............-#=:.....:=#####+:.........................................................................:+:+==###################%%%##%##%%#################=-::::::::::.......................................................
//............-#-...........:*####-......:-*-......:....................................................:---::..:*#####################%##%#%%##%###############=---:::::::.......................................................
//...........=*:..............=####=...-*#####=..:+##*-:::-*-....................................................+#################%########%%%%################*=-----::-:.......................................................
//..........-*:................=####+*=:..:*####=+-+####*-+-.....................................................-##########%###########%##%#%%%%%#%###############*++=-++-.......................................................
//.........-#=.................:*####:.....:*###+.......:+=................:......................................+#####################%##%#%##%%#%##%###################:.......................................................
//.........+#-......:*###*-.....-####+......=####:......+*:...............*--.....................................-################%%#%#######%%%###%####################*:.......................................................
//........:*#-......--:-+##=.....*####:.....-####:.....=#-...............:#-.......................................+############%####%#######%%%%#########################-.......................................................
//........:*#+...........+#+.....=####-.....-###+.....-#*..-==+:-+:+---=--#==:.=---==-:-=:*=.#-%:-.................-#########################%%%%#######%#%###############-.......................................................
//.........+##-..........-#-.....-####-.....-###=....:*#+...=--..-::-:---:-.-...--.-:-..-::-::-%:..................:+##################%######%%%%%#%%#%%#%###############-.......................................................
//.........=###-.........++......-####=.....-###-....=##=....................................=:+....................-##########%##############%%%%###%####################=.......................................................
//..........=###+-.....-+-.......:####-.....-###:...:*##=....................................::.....................:*#########################%%###%%#%#%%###########%%##+.......................................................
//...........:*########-.........:####-.....-##-....-###--=+*##*+-:..................................................-####%###%########%#######%%%%%%#%%##############%%###:......................................................
//................:..............-####:.....=#+.....=###+-::-+#####+.................................................:*##########%%######%#####%%#%%##%%%%%##########%%%##%-......................................................
//...............................=###=......++.....:*###-.......-###+.................................................=###############%#########%%%%%%%##%%##########%%%%%#=......................................................
//...............................+##*......+-....:*-+###-........:*##-................................................:##############%###%######%%%%%%%###%%#########%%%%%#*......................................................
//..............................:###-...........-#:.+###=.........-##-.................................................=####%###########%#####%###%%%%%%%%%%########%%%%%%##:.....................................................
//..............................+##=...........+#:..=###+.........:##:.................................................-###########%##############%%%%#%##%#%#######%%%%%###-.....................................................
//:...........+####+:..........=##=...........+#-...-###*:........-#-..................................................:*###########%##############%%%%%%##%########%%%%####+.....................................................
//:..........=###-............-##-..........:+#+....:*###=........+=....................................................=#####%######################%%%%%#%########%%%%%%##*:....................................................
//...........=#*:...........:=#+:...........=##:.....=####-.....:+-.....................................................-##%###########%######%######%%#%##########%%%%%%%###:....................................................
//:..........-#+..........:=#+:............-##+.......+####-::-*+.......................................................-##################%###########%%%#########%%%%%#####-....................................................
//:...........:=*=-:::-=+*+-...............+##=........=#####*=.........................................................=###########%%#%##%###########%%%#%%#######%%%%%##%##-....................................................
//.................:::....................:###=...........:............................................................:+###**#################%#%#######%%%%######%%%%%%####-....................................................
//........................................-###=...--..................................................................:-####***#####%%#########%###%####%%%#######%%%####%###=....................................................
//........................................=###+..=-=....:=....:=......................................................+%%%%#*###########################%%%%%####%%%%%%%%####=....................................................
//:.................:::.:..:.::..::.:.:...=###*..==:.::..-.::.-=.:::::.:::.-:........................................:#%%%%%%@@%%#%%#########%##%####%###%%@%%#*%%@%%%%%%#%##=....................................................
//..................*-%:#:*=:-==--+:*:+::.-####-.=:+::=:=*:=+--=:%:%:#:+:+-:=.:......................................=%#%%%@@@@@%%%@#*###################%@@@#@@@%@%%%%%%####=....................................................
//...................................-+...:####+....................................................................:#%%%%%@@@@%%#%@@%#####*##############%@%@@@%+@%%%%%%####=....................................................
//.................................:=--....+####-...................................................................=#%@%@@@@@%%%#@@@@%######%##%%##%###%#@@%@@%#*@%%%%%%%###=....................................................
//.........................................:*###*:.....................==...........................................=##%%%@@@@%%%%@@@@@%#######%#%%#%#####%%*@%%##@%%%%%#####=....................................................
//..........................................:####*:...................==...........................................-#####%%%%%%%@@@@@@@@##########%##%######%%%%*#@%%%%#%####=....................................................
//............................................+####-................:=-...........................................-###########%%%%%%%%@@@%############%#####%%%%*%@%%%%%#####+....................................................
//.............................................:+###+:............:==:...........................................:*#####*#######%%#%%%%%%%%#####%%##%#%%####%@%%%%%%%%%%######-...................................................
//...............................................:=*###=-:....::=+=:............................................:+#########%##%###%%##%%%%%%#######%%##%%####%%###%%##%%######=...................................................
//:..................................................:-==++++=-:................................................=##############%##%#####%%%%%%#####%%##%#%%###%##+*##*###*+==-:...................................................
//.............................................................................................................=##########%#####%####%##%%%%%%%%%%####%%#%%####%*+=++====---:::...................................................
//............................................................................................................:*###############%%%#%#%%%#%%#%%%%##%####%##%#####++=-------:::::...................................................
//...........................................................................................................:+########*#############%%#%#%%%%%%%%##############+==-----::::::::..................................................
//...........................................................................................................-################%###%%##%#%%%%%%%%%%%%%##%########*=-----::::::::...................................................
//:.........................................................................................................:+###############################%%%%%%####%%%%######*----:::::::::::.................................................
//:.........................................................................................................-#####*###################%%##%%%#%%%%%%%%#######%%###--:::::::::::::.................................................
//:.........................................................................................................+##############################%###%%%%%%%%%%%#%%##%#=--:::::::::::::::...............................................
//.........................................................................................................:+*####################*++#######***##%%%%%%%%#%###**=--::::::::::::::::...............................................
//.........................................................................................................:*###################%###############%%%%%####%###++=--:::::::::::::::.................................................
//:........................................................................................................-*###################%#################%%%#++=++++----::::::::::::::...................................................
//.........................................................................................................:*#########################################+=-------:::::::::::::::--..................................................
//:........................................................................................................:*################%##################%%######*=---::::::::::::::::--*#=:...............................................
//..........................................................................................................+#############################################+-----:::::::::::----*###*-.............................................
//..........................................................................................................=##############################################*==-----:::::::-----=#####*=:..........................................
//..........................................................................................................-################################################*##==-----------=--######*+=:........................................
//...........................................................................................................+######################################################+==--=------+########*+-......................................
//...........................................................................................................-##########################################################+====---=###########+-....................................
//:.....................................................................................................::....=###########################################################*+==---############*+-..................................
//...................................................................................................::::.::::.+#############################################################+==--##############*-................................
//......................................................................................................::::--.:+##*###########################################################+===%##############*-..............................
//....................................................................................................:.:::::---:*#######*#################################################*+*#**=+%#############*#*+-............................
//.....................................................................................................::::::::---+##########################*+##################################*+%###########**#****+:..........................
//........................................................................................................::::::---=#################################################################%#########*##******=:........................
//.....................................................................................................::..::::::---=+########################*########################################################*#*-::::...................
//.......................................................................................................:::.:::::---==*%############################################################**###################+-:::::.................
//....:..................................................................................................:..:::::::--=---+###############################################################################*++=-::::................
//........................................................................................................::::::::----------=++*##########################################################*###############**+=-:::................
//.....................................................................................................:::::.::::.....::.:--------=*########################################################*##############**-:.:.................
//.::.................................................................................................:...................::::::::::::--=+#######################################**##*####*+****#######+=-:-=:....................
//...:....................................................................................................................:......:::.......:+####*#############################*#*#*###**###**#*-+++=-:...........................
//..........................................................................................................................................:.:::::+-:-+####+=.:+###################**##*#######+=-...............................
//::..:...................................................................................................................................................-=:....:########*######+##**###+#*###+*+:...............................
//.:................................................................................................................................................................:..:+##########*#**####**##*#=................................
//.......................................................................................................................................................................:-+##*#**====**=+*++=-:..................................