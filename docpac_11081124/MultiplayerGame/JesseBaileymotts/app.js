// The moment I understood the weakness of my flesh, it disgusted me. I craved the strength and certainty of steel. I aspired to the purity of the blessed machine.
// 1:21:12, https://www.youtube.com/watch?v=cXxEiWudIUY&ab_channel=HusseinNasser

// Set up the variables
const { response } = require('express');
const http = require('http');
const app = require('express')();
const ws = require('websocket').server;

// Get the index.html page and listen to port 3000
app.get('/', (req, res) => res.sendFile(__dirname + '/index.html'));
app.listen(3000, console.log(`App: Listening on port 3000`));

// Create the http server 
const httpServer = http.createServer();
httpServer.listen(9090, console.log(`HTTP: Listening on port 9090`));

// Create the client hashmap for all your webfiends
const clients = {};
const games = {};

// Create the websocket server
const wss = new ws({
    'httpServer': httpServer
});

// On connecting to the server..
wss.on('request', (request) => {
    // Connect
    const connection = request.accept(null, request.origin);
    // On opening or closing a connection, relay that. 
    connection.on('open', () => console.log('Opened'));
    connection.on('close', () => console.log('Closed'));
    // On recieving a message, JSON parse the message and save it to result
    connection.on('message', (message) => {
        // This assumes all the messages being sent by the clients are JSON which is bad practice, but for simplicities sake, I am assuming all the clients will be good little webfiends
        const result = JSON.parse(message.utf8Data);
        console.log(result);
        // If the method is create...
        if (result.method === 'create') {
            // Assign the client ID and the game ID
            const clientID = result.clientID;
            const gameID = guid();
            // Add the game ID to the games object
            games[gameID] = {
                'id': gameID,
                'balls': 20,
                'clients': []
            };
            // Create the create payload for the game 
            const payload = {
                'method': 'create',
                'game': games[gameID]
            };
            // Send the create payload for the game through the client connection
            const con = clients[clientID].connection;
            con.send(JSON.stringify(payload));
        };
        // If the method is join...
        if (result.method === 'join'){
            // Set the IDs and the Game
            const clientID = result.clientID;
            const gameID = result.gameID;
            const game = games[gameID];
            // If there are more than 4 players...
            if (game.clients.length >= 4) {
                // Notify that the maximum amount of players has been reached
                console.log(`Game (${gameID}) is at maximum capacity.`)
                return;
            }
            // Set the color for the player depending on which they are
                // 1 is Red, 2 is Green, 3 is Blue, and 4 is Yellow
            const color = {'0': 'Red', '1': 'Green', '2': 'Blue', '3': 'Yellow'}[game.clients.length]
            // Add that client to the game
            game.clients.push({
                'clientID': clientID,
                'color': color
            })
            // Create the join payload for the client
            const payload = {
                'method': 'join',
                'game': game
            }

            // For each client in the game...
            game.clients.forEach((c) => {
                // Send a stringified payload to each client to notify that a new client has joined
                clients[c.clientID].connection.send(JSON.stringify(payload));
            });
        }
    });
    // Generate a new client id
    const clientID = guid();
    // Where the client is in the clients object, set the connection
    clients[clientID] = {
        connection: connection
    };
    // Create the connect payload
    const payload = {
        'method': 'connect',
        'clientID': clientID
    };
    // Send the stringified payload (client connect)
    connection.send(JSON.stringify(payload));
})

// Randomly create a hex string 4 characters long
const S4 = () => {
    return (((1+Math.random())*0x10000)|0).toString(16).substring(1); 
};

// Create a guid (Globally Unique Identifier) by concatenating multiple random hex strings together. Ensure they are all lower case
const guid = () => (S4() + S4() + "-" + S4() + "-4" + S4().substr(0,3) + "-" + S4() + "-" + S4() + S4() + S4()).toLowerCase();

// For anyone that needs a refresher on jolliness ðŸ‘‡
//................................................................................................................................................................................................................................
//................................................................................................................................................................................................................................
//................................................................................................................................................................................................................................
//................................................................................................................................:-==++++++++==-:................................................................................
//..............................................................................................................................-=+###%%#%%%%####*+=+++-..........................................................................
//............................................................................................................................:+#####@@@%#%%%%%%%######+=++=--....................................................................
//........................................................................................................................:-=+*####%@@@@%%#%@%@@@%%%##%%%%%%##*-..................................................................
//......................................................................................................................-+###*##%#%@@@@@@%#%@@@@%%%%@@@@@@@@@%#+-:................................................................
//....................................................................................................................-+#%%%%##%##@@@@@%%%#%@@@@%@@%@@@@@@@@%%%%%#-...............................................................
//..................................................................................................................-=#%%%%@%%%%##%@@@%%%%%@@@@@@@@@@@@@@@@%%%%####-..............................................................
//................................................................................................................:++#%%%%@@%%%%%#%%%%%@@%%%@%%%@@@@@@@@@@@@@@@%#%#+:.............................................................
//...............................................................................................................-+*#%%#%%@%@%%%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@%#*-.............................................................
//...............................................................................................................=##%%#%%@@@@%%%%%%%%%%%%%%#####**###%%%@%%@%%%%@@##=.............................................................
//..............................................................................................................:+#%%#%@@@@@@%%%%%%%%%%%##*+++========++#%%%%%%%%%@#+:............................................................
//.............................................................................................................-=##%%%@@%@@@@%%@@@%%%%%##*+===----==-===++*#%%%%%%#%+:............................................................
//...........................................................................................................-**+#%@@@%%@@@@@%%@@%%%%%##*+=-----------====+*#%%%%%%#+-............................................................
//.........................................................................................................:+####%%@@%%%@@@@@%%%@%%%%%%#+=-------------====+##%%%%%%#=:...........................................................
//........................................................................................................-##%%%%%%%%%%@@@@@%%%%%%#%%%#+=--------------====++#%%%%%%%*=...........................................................
//.......................................................................................................:#=:..:+##%%%@@@@%+===#%%#%%#+=--------------=--===+*#%%%%%%#+-..........................................................
//.......................................................................................................+#-.-++###%%%@@@@%+=-+=*%#%#+=----====+*+===-=--===+*###%#%%#+-:.........................................................
//......................................................................................................:**==+++*#%%%@@@@@@==+**####+==----=======*#+=---===+###%##%#*+-:.........................................................
//......................................................................................................:*##+++*#%%%%%@@@@@++*+#####+==---=+##%%##+++=====+#%%%%####*++-:.........................................................
//......................................................................................................:+#%#*###%%%%@@@@%@*++*#####+==---==+#%%+*#+=====+####%%%%##*++-:.........................................................
//.................................................................................................:==---=+=+###%%%%%%%@@@@@+=+##*#*++==----============%%%*#@%@%%##+=#=:.........................................................
//........................................................................................................::=*#%%%%#%%%%@@@@@++#*++*++====--=================#%%%##*+*#=:.........................................................
//...............................................................................................:.......:-=+==+#%%#%@%%@@@@%#*#*+++++=====--================*%%%##++%+=:.........................................................
//......................................................................................................::-:-.:=###%%%%%%@@@%#+**++++++===============--=====#@%%%%##+==..........................................................
//......................................................................................................::-=-.:##*#%@%%%%%@@%#++++++++==++==============-====@%%@%%%=+=:..........................................................
//..................................................................................................:...::-+*%#++#%%%%%%@@@@%#+++=++++++==++================#%%%%##%++-...........................................................
//..................................................................................................::...:+==:=*#%%%%%%@@@@@%#+=++==+++**+++++=============#####%#%*+=............................................................
//...................................................................................................:...:::++##%@%%@@%%%%%%##%%##*=======++*##*+**#*++==+%####%%%##*:............................................................
//...................................................................................................:..::..-=*%%##+=+%%%###=---=+##*=========+##**+*#==#%%%%%##*++++-............................................................
//..............................................................:..:.................................:..:...-++=---::------------===+#+=========+*#**=+%%%#%##*++###=:-:..........................................................
//...........................................................::::::::................................:.:.:=***=-::::::----------------===============*%%%%%###*+-**=*+:-:.........................................................
//.:......................................................::::.::::::::...............:..............::.:+++=--::::::----=====---------==+==========#%%%@%###*##===-*+=:..........................................................
//........................................................:....::::::::..............::..............::-+++---:-:---==+#########+=--------========+%%@@@@%%%#**#==--+-=+:.........................................................
//............................................................::::..:.................:..:....:......::++*=-------=+###############+=-------=+#####*####%%#%%**+%*=-===--.........................................................
//..............................::............................::::::......:........::::.......::......-*++=------+###################*=-------=#%##**++++++++++#%%%*+-=---:::.............:.......................................
//...........:..........:..::::::.:::...:.........:.:::::...:::::::::...:::.:::::::::.::::::.:::::.:::-++==+=-=-=######################+----:---=+*##++========+*%%##*+=:-:::...:..:.....::...................:................:..
//.:............::..::..:..:::..:.:::::.:::.......::.::.:..::..:::::..................................-+-**+====#########################=-----:--=+#*+=====----==#@%#+*--:::::::.::...::::::::..:::.........:::.........:::::.::.
//....................................................................................................:*--#####*#################**#####%#=--::::---=++==--------=+%@%*+=.................................................:::.....
//.....................................................................................................-*:=+*%@##################*######%%%+---::::----===---------=%@%==.........................................................
//.......................................................................................................:=#=+@##########################%%#=--:::::::---------------+%#=.........................................................
//.........................................................................................................=#=%###################%##%%##%%%#+--::::::-----------:-:--##-.........................................................
//........................................................................................................:#=#@#################%##%#%%%%#%%%#+---::::::---=----:::::--=-.........................................................
//......................................................................................................-+#--@%+###################%####%%#%%%#*+--:::::---------::::::-..........................................................
//...................................................................................................-+*+==+%%#####################%%####%%%%%###+---::::::--------:::::..........................................................
//...................................................................................................:=--=%%#%#+#################%##%##%##%%#######+-:::::::::::::-::::::.........................................................
//.....................................................................................................-*%==#-:+#################%##%#####%%%#######+--:::::::::::::::::::........................................................
//.....................................................................................................:#++=%=-+###################%#%%%##%%#%%%#####*=-:::::::::::::::::::.......................................................
//......................................................................................................:=#%-*+*****####################%##%%#########*+--::::::::::::::::........................................................
//.........................................................................................................=*+-+#**##########%%##########%#%%##*#########+--:::::::::::::::.......................................................
//......................:..................................................................................:.+--##########################%#%#############*=--:::::::::::.........................................................
//................:-*########+-..............................................................................+:-#################%##%###%##%%%%%%############+--:::::::::.:.......................................................
//..............-#=:.....:=#####+:.........................................................................:+:+==###################%%%##%##%%#################=-::::::::::.......................................................
//............-#-...........:*####-......:-*-......:....................................................:---::..:*#####################%##%#%%##%###############=---:::::::.......................................................
//...........=*:..............=####=...-*#####=..:+##*-:::-*-....................................................+#################%########%%%%################*=-----::-:.......................................................
//..........-*:................=####+*=:..:*####=+-+####*-+-.....................................................-##########%###########%##%#%%%%%#%###############*++=-++-.......................................................
//.........-#=.................:*####:.....:*###+.......:+=................:......................................+#####################%##%#%##%%#%##%###################:.......................................................
//.........+#-......:*###*-.....-####+......=####:......+*:...............*--.....................................-################%%#%#######%%%###%####################*:.......................................................
//........:*#-......--:-+##=.....*####:.....-####:.....=#-...............:#-.......................................+############%####%#######%%%%#########################-.......................................................
//........:*#+...........+#+.....=####-.....-###+.....-#*..-==+:-+:+---=--#==:.=---==-:-=:*=.#-%:-.................-#########################%%%%#######%#%###############-.......................................................
//.........+##-..........-#-.....-####-.....-###=....:*#+...=--..-::-:---:-.-...--.-:-..-::-::-%:..................:+##################%######%%%%%#%%#%%#%###############-.......................................................
//.........=###-.........++......-####=.....-###-....=##=....................................=:+....................-##########%##############%%%%###%####################=.......................................................
//..........=###+-.....-+-.......:####-.....-###:...:*##=....................................::.....................:*#########################%%###%%#%#%%###########%%##+.......................................................
//...........:*########-.........:####-.....-##-....-###--=+*##*+-:..................................................-####%###%########%#######%%%%%%#%%##############%%###:......................................................
//................:..............-####:.....=#+.....=###+-::-+#####+.................................................:*##########%%######%#####%%#%%##%%%%%##########%%%##%-......................................................
//...............................=###=......++.....:*###-.......-###+.................................................=###############%#########%%%%%%%##%%##########%%%%%#=......................................................
//...............................+##*......+-....:*-+###-........:*##-................................................:##############%###%######%%%%%%%###%%#########%%%%%#*......................................................
//..............................:###-...........-#:.+###=.........-##-.................................................=####%###########%#####%###%%%%%%%%%%########%%%%%%##:.....................................................
//..............................+##=...........+#:..=###+.........:##:.................................................-###########%##############%%%%#%##%#%#######%%%%%###-.....................................................
//:...........+####+:..........=##=...........+#-...-###*:........-#-..................................................:*###########%##############%%%%%%##%########%%%%####+.....................................................
//:..........=###-............-##-..........:+#+....:*###=........+=....................................................=#####%######################%%%%%#%########%%%%%%##*:....................................................
//...........=#*:...........:=#+:...........=##:.....=####-.....:+-.....................................................-##%###########%######%######%%#%##########%%%%%%%###:....................................................
//:..........-#+..........:=#+:............-##+.......+####-::-*+.......................................................-##################%###########%%%#########%%%%%#####-....................................................
//:...........:=*=-:::-=+*+-...............+##=........=#####*=.........................................................=###########%%#%##%###########%%%#%%#######%%%%%##%##-....................................................
//.................:::....................:###=...........:............................................................:+###**#################%#%#######%%%%######%%%%%%####-....................................................
//........................................-###=...--..................................................................:-####***#####%%#########%###%####%%%#######%%%####%###=....................................................
//........................................=###+..=-=....:=....:=......................................................+%%%%#*###########################%%%%%####%%%%%%%%####=....................................................
//:.................:::.:..:.::..::.:.:...=###*..==:.::..-.::.-=.:::::.:::.-:........................................:#%%%%%%@@%%#%%#########%##%####%###%%@%%#*%%@%%%%%%#%##=....................................................
//..................*-%:#:*=:-==--+:*:+::.-####-.=:+::=:=*:=+--=:%:%:#:+:+-:=.:......................................=%#%%%@@@@@%%%@#*###################%@@@#@@@%@%%%%%%####=....................................................
//...................................-+...:####+....................................................................:#%%%%%@@@@%%#%@@%#####*##############%@%@@@%+@%%%%%%####=....................................................
//.................................:=--....+####-...................................................................=#%@%@@@@@%%%#@@@@%######%##%%##%###%#@@%@@%#*@%%%%%%%###=....................................................
//.........................................:*###*:.....................==...........................................=##%%%@@@@%%%%@@@@@%#######%#%%#%#####%%*@%%##@%%%%%#####=....................................................
//..........................................:####*:...................==...........................................-#####%%%%%%%@@@@@@@@##########%##%######%%%%*#@%%%%#%####=....................................................
//............................................+####-................:=-...........................................-###########%%%%%%%%@@@%############%#####%%%%*%@%%%%%#####+....................................................
//.............................................:+###+:............:==:...........................................:*#####*#######%%#%%%%%%%%#####%%##%#%%####%@%%%%%%%%%%######-...................................................
//...............................................:=*###=-:....::=+=:............................................:+#########%##%###%%##%%%%%%#######%%##%%####%%###%%##%%######=...................................................
//:..................................................:-==++++=-:................................................=##############%##%#####%%%%%%#####%%##%#%%###%##+*##*###*+==-:...................................................
//.............................................................................................................=##########%#####%####%##%%%%%%%%%%####%%#%%####%*+=++====---:::...................................................
//............................................................................................................:*###############%%%#%#%%%#%%#%%%%##%####%##%#####++=-------:::::...................................................
//...........................................................................................................:+########*#############%%#%#%%%%%%%%##############+==-----::::::::..................................................
//...........................................................................................................-################%###%%##%#%%%%%%%%%%%%%##%########*=-----::::::::...................................................
//:.........................................................................................................:+###############################%%%%%%####%%%%######*----:::::::::::.................................................
//:.........................................................................................................-#####*###################%%##%%%#%%%%%%%%#######%%###--:::::::::::::.................................................
//:.........................................................................................................+##############################%###%%%%%%%%%%%#%%##%#=--:::::::::::::::...............................................
//.........................................................................................................:+*####################*++#######***##%%%%%%%%#%###**=--::::::::::::::::...............................................
//.........................................................................................................:*###################%###############%%%%%####%###++=--:::::::::::::::.................................................
//:........................................................................................................-*###################%#################%%%#++=++++----::::::::::::::...................................................
//.........................................................................................................:*#########################################+=-------:::::::::::::::--..................................................
//:........................................................................................................:*################%##################%%######*=---::::::::::::::::--*#=:...............................................
//..........................................................................................................+#############################################+-----:::::::::::----*###*-.............................................
//..........................................................................................................=##############################################*==-----:::::::-----=#####*=:..........................................
//..........................................................................................................-################################################*##==-----------=--######*+=:........................................
//...........................................................................................................+######################################################+==--=------+########*+-......................................
//...........................................................................................................-##########################################################+====---=###########+-....................................
//:.....................................................................................................::....=###########################################################*+==---############*+-..................................
//...................................................................................................::::.::::.+#############################################################+==--##############*-................................
//......................................................................................................::::--.:+##*###########################################################+===%##############*-..............................
//....................................................................................................:.:::::---:*#######*#################################################*+*#**=+%#############*#*+-............................
//.....................................................................................................::::::::---+##########################*+##################################*+%###########**#****+:..........................
//........................................................................................................::::::---=#################################################################%#########*##******=:........................
//.....................................................................................................::..::::::---=+########################*########################################################*#*-::::...................
//.......................................................................................................:::.:::::---==*%############################################################**###################+-:::::.................
//....:..................................................................................................:..:::::::--=---+###############################################################################*++=-::::................
//........................................................................................................::::::::----------=++*##########################################################*###############**+=-:::................
//.....................................................................................................:::::.::::.....::.:--------=*########################################################*##############**-:.:.................
//.::.................................................................................................:...................::::::::::::--=+#######################################**##*####*+****#######+=-:-=:....................
//...:....................................................................................................................:......:::.......:+####*#############################*#*#*###**###**#*-+++=-:...........................
//..........................................................................................................................................:.:::::+-:-+####+=.:+###################**##*#######+=-...............................
//::..:...................................................................................................................................................-=:....:########*######+##**###+#*###+*+:...............................
//.:................................................................................................................................................................:..:+##########*#**####**##*#=................................
//.......................................................................................................................................................................:-+##*#**====**=+*++=-:..................................