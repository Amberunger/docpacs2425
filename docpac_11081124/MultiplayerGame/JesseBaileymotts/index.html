<!DOCTYPE html>
<html lang='en'>
<head>
    <meta charset='UTF-8'>
    <meta name='viewport' content='width=device-width, initial-scale=1.0'>
    <link rel='stylesheet' href='/style.css'>
    <title>SplatoonD</title>
</head>
<body>
    <!-- Splatoon 2D -->
    <h1>SplatoonD</h1>
    <!-- Game Creation -->
    <button id='newGame'>New Game</button>
    <button id='joinGame'>Join Game</button>
    <input type='text' id='code'>
    <!-- Game Information -->
    <div id='clock'></div>
    <div id='players'></div>
    <div id='winner'></div>
    <!-- Game Board -->
    <div id='board'></div>
    <!-- JS Code -->
    <script>
        //// HTML Elements
        // In order of which they appear
        const newGame = document.getElementById('newGame');
        const joinGame = document.getElementById('joinGame');
        const code = document.getElementById('code');
        const clock = document.getElementById('clock');
        const players = document.getElementById('players');
        const winner = document.getElementById('winner');
        const board = document.getElementById('board');
        
        //// Splatoon 2D Variables
        // It is poor practice to make the websocket like this. However my dearest little webfiends, it okay
        let ws = new WebSocket('ws://localhost:9090');
        let clientID = null;
        let gameID = null;
        let pColor = null;
        let timer = null;
        let gameEnd = false;
        // A compare function for proper score sorting
        let compare = (a, b) => {
            return a - b;
        };

        //// HTML Events
        // On clicking join game...
        joinGame.addEventListener('click', (e) => {
            // Create the join payload
            if (gameID === null) {
                gameID = code.value;
            }
            const payload = {
                'method': 'join',
                'clientID': clientID,
                'gameID': gameID
            };
            // Stringify and send the join payload
            ws.send(JSON.stringify(payload));
        });
        // On clicking new game...
        newGame.addEventListener('click', (e) => {
            // Create the create payload
            const payload = {
                'method': 'create',
                'clientID': clientID
            };
            // Stringify and send the create payload
            ws.send(JSON.stringify(payload));
        });

        // On recieving a websocket message...
        ws.onmessage = message => {
            const response = JSON.parse(message.data);
            // If the method is connect...
            if (response.method == 'connect') {
                // Assign and relay the client ID
                clientID = response.clientID;
                console.log(`Client ID Set: ${clientID}`);
            };
            // If the method is create...
            if (response.method === 'create') {
                // Assign and relay the game ID
                gameID = response.game.id;
                console.log(`Game ID Set: ${response.game.id}`);
            };
            // If the method is join...
            if (response.method === 'join') {
                // Set the text of the clock div to the remaining time
                clock.innerText = `Time: ${response.game.time}`;
                // Assign the game
                game = response.game;
                // While the players div has elements, remove the first element
                while (players.firstChild) players.removeChild(players.firstChild);
                // For each client in the game...
                game.clients.forEach((c) => {
                    // Create a div element, style it, and add into it the client ID
                    const div = document.createElement('div');
                    div.id = c.clientID;
                    div.style.width = '5rem';
                    div.style.background = c.color;
                    div.textContent = `${c.player}: ${c.score}`;
                    // If the client's ID matches the current client, their player color is the client's color
                    if (c.clientID === clientID) pColor = c.color;
                    // Append the client's div to the players div
                    players.appendChild(div);
                });
                // While the board div has elements, remove the first element
                while (board.firstChild) board.removeChild(board.firstChild);
                // Start i at 0. While i is less than the game boxes, increment i by 1 and...
                for (let i = 0; i < game.boxes; i++) {
                    // Create a button element and assign an ID and Tag
                    const box = document.createElement('button')
                    box.id = 'b'+(i+1);
                    box.tag = i+1;
                    // Style the button
                    box.textContent = i+1;
                    box.style.width = '4.5rem';
                    box.style.height = '4.5rem';
                    // Add clicking functionality to the button
                    box.addEventListener('click', (e) => {
                        // Set the clicked box to the player color
                        box.style.background = pColor;
                        // Create the play payload
                        const payload = {
                            'method': 'play',
                            'clientID': clientID,
                            'gameID': gameID,
                            'boxID': box.tag,
                            'color': pColor
                        }
                        // Stringify and send the play payload
                        ws.send(JSON.stringify(payload));
                    });
                    // Append the box to the board. If there are eight boxes already, break
                    // Results in a 8 x 8 grid
                    // If the total boxes are increased, it must be exponentially to result in an evenly distributed and, thus, square grid
                    // For example, a 12 x 12 grid would be 144 boxes. A 20 x 20 grid would be 400
                    board.appendChild(box);
                    if (((i + 1) % (game.boxes / Math.sqrt(game.boxes))) === 0) board.appendChild(document.createElement('br'));
                };
            };
            // If the method is update...
            if (response.method === 'update') {
                const game = response.game;
                // Update the text of the clock div to the current game time
                clock.innerText = `Time: ${game.time}`;
                // For each client in the game...
                game.clients.forEach((c) => {
                    // If the player div exists...
                    if (document.getElementById(c.clientID)) {
                        // Set the playerBox constant equal to that client's ID
                        const playerBox = document.getElementById(c.clientID)
                        // Update the text content with that player's score
                        playerBox.textContent = `${c.player}: ${c.score}`;
                    };
                });
                // If there is no game state, return
                if (!game.state) return;
                // For boxes of the game's state...
                for (const b of Object.keys(game.state)) {
                    // Set color to the color of said box
                    const color = game.state[b];
                    // Set boxObj to said box on the board
                    const boxObj = document.getElementById('b' + b);
                    // Set the boxObj's background color to the color gotten
                    boxObj.style.backgroundColor = color;
                };
                // If the game's time is less than or equal to 0...
                if (game.time <= 0) {
                    if (gameEnd === false) {
                        // Set allBoxes to all buttons within the board
                        const allBoxes = document.querySelectorAll('#board button');
                        // For each box, set the box to disabled
                        allBoxes.forEach((box) => box.disabled = true);
                        // Let scores equal an empty array
                        let scores = [];
                        // For each client in the game... 
                        game.clients.forEach((c) => {
                            // Push their score to scores
                            scores.push(c.score);
                        });
                        // Sort scores with the compare functions
                        scores.sort(compare);
                        // scores[scores.length - 1]
                        game.clients.forEach((c) => {
                            const div = document.createElement('div');
                            div.id = c.player;
                            div.style.width = '4rem';
                            div.style.color = c.color;
                            winner.appendChild(div);
                            console.log(div);
                        });
                        gameEnd = true;
                        
                    };
                };
            };
        };
    </script>
</body>
</html>