// The moment I understood the weakness of my flesh, it disgusted me. I craved the strength and certainty of steel. I aspired to the purity of the blessed machine.
// 1:38:48, https://www.youtube.com/watch?v=cXxEiWudIUY&ab_channel=HusseinNasser

// Set up the variables
const { response } = require('express');
const http = require('http');
const app = require('express')();
const ws = require('websocket').server;

// Get the index.html page and listen to port 3000
app.get('/', (req, res) => res.sendFile(__dirname + '/index.html'));
app.listen(3000, console.log(`App: Listening on port 3000`));

// Create the http server 
const httpServer = http.createServer();
httpServer.listen(9090, console.log(`HTTP: Listening on port 9090`));

// Create the client hashmap for all your webfiends
const clients = {};
const games = {};

// Create the websocket server
// My socks are soggy and gross!
const wss = new ws({
    'httpServer': httpServer
});

// On connecting to the server..
wss.on('request', (request) => {
    // Connect
    const connection = request.accept(null, request.origin);
    // On opening or closing a connection, relay that. 
    connection.on('open', () => console.log('Opened'));
    connection.on('close', () => console.log('Closed'));
    // On recieving a message, JSON parse the message and save it to result
    connection.on('message', (message) => {
        // This assumes all the messages being sent by the clients are JSON which is bad practice, but for simplicities sake, I am assuming all the clients will be good little webfiends. Webfriends, if you will
        const result = JSON.parse(message.utf8Data);
        console.log(result);
        // If the method is create...
        if (result.method === 'create') {
            // Assign the client ID and the game ID
            const clientID = result.clientID;
            const gameID = guid();
            // Add the game ID to the games object
            games[gameID] = {
                'id': gameID,
                'boxes': 64,
                'clients': []
            };
            // Create the create payload 
            const payload = {
                'method': 'create',
                'game': games[gameID]
            };
            // Send the create payload for the game through the client connection
            const con = clients[clientID].connection;
            con.send(JSON.stringify(payload));
        };
        // If the method is join...
        if (result.method === 'join'){
            // Set the IDs and the Game
            const clientID = result.clientID;
            const gameID = result.gameID;
            const game = games[gameID];
            // If there are more than 5 players...
            if (game.clients.length >= 5) {
                // Notify that the maximum amount of players has been reached
                console.log(`Game (${gameID}) is at maximum capacity.`)
                return;
            }
            // Set the color for the player depending on which they are
            // 1 is Red, 2 is Yellow, 3 is Green, 4 is Cyan, 5 is Purple 
            const color = {'0': '#ff0000', '1': '#ffff00', '2': '#00ff00', '3': '#00ffff', '4': '#ff00ff'}[game.clients.length]
            // Add that client to the game
            game.clients.push({
                'clientID': clientID,
                'color': color
            });
            // If there are more than one clients, start the game
            if (game.clients.length > 1) update();
            // Create the join payload
            const payload = {
                'method': 'join',
                'game': game
            };

            // For each client in the game...
            game.clients.forEach((c) => {
                // Send a stringified payload to each client to notify that a new client has joined
                clients[c.clientID].connection.send(JSON.stringify(payload));
            });
        };
        // If the method is play... 
        if (result.method === 'play') {
            // Set the IDs for the game and box, and assign the box's color
            const gameID = result.gameID;
            const boxID = result.boxID;
            const color = result.color;
            // Assign the state of the game 
            let state = games[gameID].state;
            // If there is no state, assign an empty object to state
            if (!state) state = {};
            // Assign the client's color to the box and update the game state
            state[boxID] = color;
            games[gameID].state = state;
        }
    });
    // Generate a new client id
    const clientID = guid();
    // Where the client is in the clients object, set the connection
    clients[clientID] = {
        connection: connection
    };
    // Create the connect payload
    const payload = {
        'method': 'connect',
        'clientID': clientID
    };
    // Send the stringified payload (client connect)
    connection.send(JSON.stringify(payload));
});

// Create a function to update the game
let update = () => {
    // For game of games..
    // Loop through all the keys ( {'gameID':, gameID} )
    for (const g of Object.keys(games)) {
        // Set the game from the games object
        const game = games[g];
        // Create the update payload
        const payload = {
            'method': 'update',
            'game': game
        };
        // For each client in games...
        game.clients.forEach(c => {
            // Stringify and send the update payload
            clients[c.clientID].connection.send(JSON.stringify(payload));
            console.log(payload);
        });
    };
    setTimeout(update, 500);
};

// Create a function to randomly create a hex string 4 characters long
const S4 = () => {
    return (((1+Math.random())*0x10000)|0).toString(16).substring(1); 
};

// Create a guid (Globally Unique Identifier) by concatenating multiple random hex strings together. Ensure they are all lower case
const guid = () => (S4() + S4() + "-" + S4() + "-4" + S4().substr(0,3) + "-" + S4() + "-" + S4() + S4() + S4()).toLowerCase();

// For anyone that needs a refresher on jolliness ðŸ‘‡
//................................................................................................................................................................................................................................
//................................................................................................................................................................................................................................
//................................................................................................................................................................................................................................
//................................................................................................................................:-==++++++++==-:................................................................................
//..............................................................................................................................-=+###%%#%%%%####*+=+++-..........................................................................
//............................................................................................................................:+#####@@@%#%%%%%%%######+=++=--....................................................................
//........................................................................................................................:-=+*####%@@@@%%#%@%@@@%%%##%%%%%%##*-..................................................................
//......................................................................................................................-+###*##%#%@@@@@@%#%@@@@%%%%@@@@@@@@@%#+-:................................................................
//....................................................................................................................-+#%%%%##%##@@@@@%%%#%@@@@%@@%@@@@@@@@%%%%%#-...............................................................
//..................................................................................................................-=#%%%%@%%%%##%@@@%%%%%@@@@@@@@@@@@@@@@%%%%####-..............................................................
//................................................................................................................:++#%%%%@@%%%%%#%%%%%@@%%%@%%%@@@@@@@@@@@@@@@%#%#+:.............................................................
//...............................................................................................................-+*#%%#%%@%@%%%#%%%%%%%%%%%%%%%%%%%%%%%%%%%%@@@@%#*-.............................................................
//...............................................................................................................=##%%#%%@@@@%%%%%%%%%%%%%%#####**###%%%@%%@%%%%@@##=.............................................................
//..............................................................................................................:+#%%#%@@@@@@%%%%%%%%%%%##*+++========++#%%%%%%%%%@#+:............................................................
//.............................................................................................................-=##%%%@@%@@@@%%@@@%%%%%##*+===----==-===++*#%%%%%%#%+:............................................................
//...........................................................................................................-**+#%@@@%%@@@@@%%@@%%%%%##*+=-----------====+*#%%%%%%#+-............................................................
//.........................................................................................................:+####%%@@%%%@@@@@%%%@%%%%%%#+=-------------====+##%%%%%%#=:...........................................................
//........................................................................................................-##%%%%%%%%%%@@@@@%%%%%%#%%%#+=--------------====++#%%%%%%%*=...........................................................
//.......................................................................................................:#=:..:+##%%%@@@@%+===#%%#%%#+=--------------=--===+*#%%%%%%#+-..........................................................
//.......................................................................................................+#-.-++###%%%@@@@%+=-+=*%#%#+=----====+*+===-=--===+*###%#%%#+-:.........................................................
//......................................................................................................:**==+++*#%%%@@@@@@==+**####+==----=======*#+=---===+###%##%#*+-:.........................................................
//......................................................................................................:*##+++*#%%%%%@@@@@++*+#####+==---=+##%%##+++=====+#%%%%####*++-:.........................................................
//......................................................................................................:+#%#*###%%%%@@@@%@*++*#####+==---==+#%%+*#+=====+####%%%%##*++-:.........................................................
//.................................................................................................:==---=+=+###%%%%%%%@@@@@+=+##*#*++==----============%%%*#@%@%%##+=#=:.........................................................
//........................................................................................................::=*#%%%%#%%%%@@@@@++#*++*++====--=================#%%%##*+*#=:.........................................................
//...............................................................................................:.......:-=+==+#%%#%@%%@@@@%#*#*+++++=====--================*%%%##++%+=:.........................................................
//......................................................................................................::-:-.:=###%%%%%%@@@%#+**++++++===============--=====#@%%%%##+==..........................................................
//......................................................................................................::-=-.:##*#%@%%%%%@@%#++++++++==++==============-====@%%@%%%=+=:..........................................................
//..................................................................................................:...::-+*%#++#%%%%%%@@@@%#+++=++++++==++================#%%%%##%++-...........................................................
//..................................................................................................::...:+==:=*#%%%%%%@@@@@%#+=++==+++**+++++=============#####%#%*+=............................................................
//...................................................................................................:...:::++##%@%%@@%%%%%%##%%##*=======++*##*+**#*++==+%####%%%##*:............................................................
//...................................................................................................:..::..-=*%%##+=+%%%###=---=+##*=========+##**+*#==#%%%%%##*++++-............................................................
//..............................................................:..:.................................:..:...-++=---::------------===+#+=========+*#**=+%%%#%##*++###=:-:..........................................................
//...........................................................::::::::................................:.:.:=***=-::::::----------------===============*%%%%%###*+-**=*+:-:.........................................................
//.:......................................................::::.::::::::...............:..............::.:+++=--::::::----=====---------==+==========#%%%@%###*##===-*+=:..........................................................
//........................................................:....::::::::..............::..............::-+++---:-:---==+#########+=--------========+%%@@@@%%%#**#==--+-=+:.........................................................
//............................................................::::..:.................:..:....:......::++*=-------=+###############+=-------=+#####*####%%#%%**+%*=-===--.........................................................
//..............................::............................::::::......:........::::.......::......-*++=------+###################*=-------=#%##**++++++++++#%%%*+-=---:::.............:.......................................
//...........:..........:..::::::.:::...:.........:.:::::...:::::::::...:::.:::::::::.::::::.:::::.:::-++==+=-=-=######################+----:---=+*##++========+*%%##*+=:-:::...:..:.....::...................:................:..
//.:............::..::..:..:::..:.:::::.:::.......::.::.:..::..:::::..................................-+-**+====#########################=-----:--=+#*+=====----==#@%#+*--:::::::.::...::::::::..:::.........:::.........:::::.::.
//....................................................................................................:*--#####*#################**#####%#=--::::---=++==--------=+%@%*+=.................................................:::.....
//.....................................................................................................-*:=+*%@##################*######%%%+---::::----===---------=%@%==.........................................................
//.......................................................................................................:=#=+@##########################%%#=--:::::::---------------+%#=.........................................................
//.........................................................................................................=#=%###################%##%%##%%%#+--::::::-----------:-:--##-.........................................................
//........................................................................................................:#=#@#################%##%#%%%%#%%%#+---::::::---=----:::::--=-.........................................................
//......................................................................................................-+#--@%+###################%####%%#%%%#*+--:::::---------::::::-..........................................................
//...................................................................................................-+*+==+%%#####################%%####%%%%%###+---::::::--------:::::..........................................................
//...................................................................................................:=--=%%#%#+#################%##%##%##%%#######+-:::::::::::::-::::::.........................................................
//.....................................................................................................-*%==#-:+#################%##%#####%%%#######+--:::::::::::::::::::........................................................
//.....................................................................................................:#++=%=-+###################%#%%%##%%#%%%#####*=-:::::::::::::::::::.......................................................
//......................................................................................................:=#%-*+*****####################%##%%#########*+--::::::::::::::::........................................................
//.........................................................................................................=*+-+#**##########%%##########%#%%##*#########+--:::::::::::::::.......................................................
//......................:..................................................................................:.+--##########################%#%#############*=--:::::::::::.........................................................
//................:-*########+-..............................................................................+:-#################%##%###%##%%%%%%############+--:::::::::.:.......................................................
//..............-#=:.....:=#####+:.........................................................................:+:+==###################%%%##%##%%#################=-::::::::::.......................................................
//............-#-...........:*####-......:-*-......:....................................................:---::..:*#####################%##%#%%##%###############=---:::::::.......................................................
//...........=*:..............=####=...-*#####=..:+##*-:::-*-....................................................+#################%########%%%%################*=-----::-:.......................................................
//..........-*:................=####+*=:..:*####=+-+####*-+-.....................................................-##########%###########%##%#%%%%%#%###############*++=-++-.......................................................
//.........-#=.................:*####:.....:*###+.......:+=................:......................................+#####################%##%#%##%%#%##%###################:.......................................................
//.........+#-......:*###*-.....-####+......=####:......+*:...............*--.....................................-################%%#%#######%%%###%####################*:.......................................................
//........:*#-......--:-+##=.....*####:.....-####:.....=#-...............:#-.......................................+############%####%#######%%%%#########################-.......................................................
//........:*#+...........+#+.....=####-.....-###+.....-#*..-==+:-+:+---=--#==:.=---==-:-=:*=.#-%:-.................-#########################%%%%#######%#%###############-.......................................................
//.........+##-..........-#-.....-####-.....-###=....:*#+...=--..-::-:---:-.-...--.-:-..-::-::-%:..................:+##################%######%%%%%#%%#%%#%###############-.......................................................
//.........=###-.........++......-####=.....-###-....=##=....................................=:+....................-##########%##############%%%%###%####################=.......................................................
//..........=###+-.....-+-.......:####-.....-###:...:*##=....................................::.....................:*#########################%%###%%#%#%%###########%%##+.......................................................
//...........:*########-.........:####-.....-##-....-###--=+*##*+-:..................................................-####%###%########%#######%%%%%%#%%##############%%###:......................................................
//................:..............-####:.....=#+.....=###+-::-+#####+.................................................:*##########%%######%#####%%#%%##%%%%%##########%%%##%-......................................................
//...............................=###=......++.....:*###-.......-###+.................................................=###############%#########%%%%%%%##%%##########%%%%%#=......................................................
//...............................+##*......+-....:*-+###-........:*##-................................................:##############%###%######%%%%%%%###%%#########%%%%%#*......................................................
//..............................:###-...........-#:.+###=.........-##-.................................................=####%###########%#####%###%%%%%%%%%%########%%%%%%##:.....................................................
//..............................+##=...........+#:..=###+.........:##:.................................................-###########%##############%%%%#%##%#%#######%%%%%###-.....................................................
//:...........+####+:..........=##=...........+#-...-###*:........-#-..................................................:*###########%##############%%%%%%##%########%%%%####+.....................................................
//:..........=###-............-##-..........:+#+....:*###=........+=....................................................=#####%######################%%%%%#%########%%%%%%##*:....................................................
//...........=#*:...........:=#+:...........=##:.....=####-.....:+-.....................................................-##%###########%######%######%%#%##########%%%%%%%###:....................................................
//:..........-#+..........:=#+:............-##+.......+####-::-*+.......................................................-##################%###########%%%#########%%%%%#####-....................................................
//:...........:=*=-:::-=+*+-...............+##=........=#####*=.........................................................=###########%%#%##%###########%%%#%%#######%%%%%##%##-....................................................
//.................:::....................:###=...........:............................................................:+###**#################%#%#######%%%%######%%%%%%####-....................................................
//........................................-###=...--..................................................................:-####***#####%%#########%###%####%%%#######%%%####%###=....................................................
//........................................=###+..=-=....:=....:=......................................................+%%%%#*###########################%%%%%####%%%%%%%%####=....................................................
//:.................:::.:..:.::..::.:.:...=###*..==:.::..-.::.-=.:::::.:::.-:........................................:#%%%%%%@@%%#%%#########%##%####%###%%@%%#*%%@%%%%%%#%##=....................................................
//..................*-%:#:*=:-==--+:*:+::.-####-.=:+::=:=*:=+--=:%:%:#:+:+-:=.:......................................=%#%%%@@@@@%%%@#*###################%@@@#@@@%@%%%%%%####=....................................................
//...................................-+...:####+....................................................................:#%%%%%@@@@%%#%@@%#####*##############%@%@@@%+@%%%%%%####=....................................................
//.................................:=--....+####-...................................................................=#%@%@@@@@%%%#@@@@%######%##%%##%###%#@@%@@%#*@%%%%%%%###=....................................................
//.........................................:*###*:.....................==...........................................=##%%%@@@@%%%%@@@@@%#######%#%%#%#####%%*@%%##@%%%%%#####=....................................................
//..........................................:####*:...................==...........................................-#####%%%%%%%@@@@@@@@##########%##%######%%%%*#@%%%%#%####=....................................................
//............................................+####-................:=-...........................................-###########%%%%%%%%@@@%############%#####%%%%*%@%%%%%#####+....................................................
//.............................................:+###+:............:==:...........................................:*#####*#######%%#%%%%%%%%#####%%##%#%%####%@%%%%%%%%%%######-...................................................
//...............................................:=*###=-:....::=+=:............................................:+#########%##%###%%##%%%%%%#######%%##%%####%%###%%##%%######=...................................................
//:..................................................:-==++++=-:................................................=##############%##%#####%%%%%%#####%%##%#%%###%##+*##*###*+==-:...................................................
//.............................................................................................................=##########%#####%####%##%%%%%%%%%%####%%#%%####%*+=++====---:::...................................................
//............................................................................................................:*###############%%%#%#%%%#%%#%%%%##%####%##%#####++=-------:::::...................................................
//...........................................................................................................:+########*#############%%#%#%%%%%%%%##############+==-----::::::::..................................................
//...........................................................................................................-################%###%%##%#%%%%%%%%%%%%%##%########*=-----::::::::...................................................
//:.........................................................................................................:+###############################%%%%%%####%%%%######*----:::::::::::.................................................
//:.........................................................................................................-#####*###################%%##%%%#%%%%%%%%#######%%###--:::::::::::::.................................................
//:.........................................................................................................+##############################%###%%%%%%%%%%%#%%##%#=--:::::::::::::::...............................................
//.........................................................................................................:+*####################*++#######***##%%%%%%%%#%###**=--::::::::::::::::...............................................
//.........................................................................................................:*###################%###############%%%%%####%###++=--:::::::::::::::.................................................
//:........................................................................................................-*###################%#################%%%#++=++++----::::::::::::::...................................................
//.........................................................................................................:*#########################################+=-------:::::::::::::::--..................................................
//:........................................................................................................:*################%##################%%######*=---::::::::::::::::--*#=:...............................................
//..........................................................................................................+#############################################+-----:::::::::::----*###*-.............................................
//..........................................................................................................=##############################################*==-----:::::::-----=#####*=:..........................................
//..........................................................................................................-################################################*##==-----------=--######*+=:........................................
//...........................................................................................................+######################################################+==--=------+########*+-......................................
//...........................................................................................................-##########################################################+====---=###########+-....................................
//:.....................................................................................................::....=###########################################################*+==---############*+-..................................
//...................................................................................................::::.::::.+#############################################################+==--##############*-................................
//......................................................................................................::::--.:+##*###########################################################+===%##############*-..............................
//....................................................................................................:.:::::---:*#######*#################################################*+*#**=+%#############*#*+-............................
//.....................................................................................................::::::::---+##########################*+##################################*+%###########**#****+:..........................
//........................................................................................................::::::---=#################################################################%#########*##******=:........................
//.....................................................................................................::..::::::---=+########################*########################################################*#*-::::...................
//.......................................................................................................:::.:::::---==*%############################################################**###################+-:::::.................
//....:..................................................................................................:..:::::::--=---+###############################################################################*++=-::::................
//........................................................................................................::::::::----------=++*##########################################################*###############**+=-:::................
//.....................................................................................................:::::.::::.....::.:--------=*########################################################*##############**-:.:.................
//.::.................................................................................................:...................::::::::::::--=+#######################################**##*####*+****#######+=-:-=:....................
//...:....................................................................................................................:......:::.......:+####*#############################*#*#*###**###**#*-+++=-:...........................
//..........................................................................................................................................:.:::::+-:-+####+=.:+###################**##*#######+=-...............................
//::..:...................................................................................................................................................-=:....:########*######+##**###+#*###+*+:...............................
//.:................................................................................................................................................................:..:+##########*#**####**##*#=................................
//.......................................................................................................................................................................:-+##*#**====**=+*++=-:..................................